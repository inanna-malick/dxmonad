#!/bin/bash
set -e

docker events --filter=event=start | \
while read container_id; do
    container_id=$(echo $container_id | cut -d ' ' -f2)
    echo "start event for container $container_id"

    # from https://blog.amartynov.ru/archives/dnsmasq-docker-service-discovery/
    # Domain name for containers
    CONTAINER_DOMAIN=local.io

    # Path to the addn-hosts file
    CONTAINER_HOSTS=/docker-container-hosts
    CONTAINER_HOSTS_TMP=/docker-container-hosts.tmp

    echo "# Auto-generated by $0" > $CONTAINER_HOSTS_TMP
    for CID in `docker ps -q`; do
        IP=`docker inspect --format '{{ .NetworkSettings.IPAddress }}' $CID`
        NAME=`docker inspect --format '{{ .Name }}' $CID`
        # name starts with /, so trim first character
        NAME=${NAME:1}
        echo "$IP  $NAME.$CONTAINER_DOMAIN" >> $CONTAINER_HOSTS_TMP
    done

    cmp -s $CONTAINER_HOSTS $CONTAINER_HOSTS_TMP > /dev/null
    if [ $? -eq 1 ]; then
        echo is different
        cat $CONTAINER_HOSTS_TMP
        mv -f $CONTAINER_HOSTS_TMP $CONTAINER_HOSTS
        # Ask dnsmasq to reload addn-hosts
        pkill -x -HUP dnsmasq
    else
        echo is not different
        rm $CONTAINER_HOSTS_TMP
    fi
done
