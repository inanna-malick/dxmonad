#!/bin/bash
#set -e


# todo: read home dir instead of hardcoding

PATH=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin

USER_UID=$(id -u)
USER_GID=$(id -g)

function require {
  IMAGE=$1
  NAME=$2
  docker start $NAME \
    || docker run -d --name $NAME $IMAGE \
    || true
}

# these are no longer linked by dxmonad, but they should still be up
require "postgres:9.4" "postgres"
require "redis:2.8"    "redis"

# todo: need to ensure all these directories exist, else
# they will be created w/ root as owner
# todo: simple bash loop
dxmonad_up() {
    NAME=$1
    RUNWITH=$2
    docker run \
        --name $NAME \
        --env USER_UID=${USER_UID} \
        --env USER_GID=${USER_GID} \
        --env DISPLAY=${DISPLAY} \
        --env BOX_NAME=${NAME} \
        --volume=/home/paul/.sbt:/home/dev/.sbt \
        --volume=/home/paul/.ivy2:/home/dev/.ivy2 \
        --volume=/home/paul/.mozilla:/home/dev/.mozilla \
        --volume=/home/paul/.IntelliJIdea14:/home/dev/.IntelliJIdea14 \
        --volume=/home/paul/.ssh:/home/dev/.ssh \
        --volume=/home/paul/dxmonad:/home/dev/dxmonad \
        --volume=/home/paul/work:/home/dev/work \
        --volume=/var/run/docker.sock:/var/run/docker.sock \
        --volume=/tmp/.X11-unix:/tmp/.X11-unix \
        --volume=/run/user/${USER_UID}/pulse:/run/pulse \
        pkinsky/dxmonad:latest $RUNWITH
}


if [ "$1" == "test" ]; then
    docker kill dxmonad-test
    docker rm   dxmonad-test
    echo "Bring up dxmonad-test"
    dxmonad_up  dxmonad-test "xmonad --recompile"
    echo "done recompiling"
else
    docker kill dxmonad
    docker rm   dxmonad
    echo "Starting dxmonad..."
    dxmonad_up  dxmonad
fi
