#!/bin/bash
#set -e


# todo: read home dir instead of hardcoding

PATH=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin

USER_UID=$(id -u)
USER_GID=$(id -g)

#echo "starting dx-mysql"
#dx-mysql

#echo "starting dockerui"
#dockerui

echo "starting redis"
# can fail if docker is already running
# todo: write some q+d python script to startup dxmonad
docker run --name redis -d redis:2.8

echo "starting postgres"
docker run --name postgres -d postgres:9.4

# todo: need to ensure all these directories exist, else
# they will be created w/ root as owner
# todo: just bite the bullet and use python
dxmonad_up() {
    NAME=$1
    RUNWITH=$2
    docker run \
        --name $NAME \
        --env USER_UID=${USER_UID} \
        --env USER_GID=${USER_GID} \
        --env DISPLAY=${DISPLAY} \
        --link redis:redis \
        --link postgres:postgres \
        --volume=/home/paul/.sbt:/home/dev/.sbt \
        --volume=/home/paul/.ivy2:/home/dev/.ivy2 \
        --volume=/home/paul/.mozilla:/home/dev/.mozilla \
        --volume=/home/paul/.IntelliJIdea14:/home/dev/.IntelliJIdea14 \
        --volume=/home/paul/.ssh:/home/dev/.ssh \
        --volume=/home/paul/dxmonad:/home/dev/dxmonad \
        --volume=/home/paul/work:/home/dev/work \
        --volume=/var/run/docker.sock:/var/run/docker.sock \
        --volume=/tmp/.X11-unix:/tmp/.X11-unix \
        --volume=/run/user/${USER_UID}/pulse:/run/pulse \
        pkinsky/dxmonad:latest $RUNWITH
}


if [ "$1" == "test" ]; then
    docker kill dxmonad-test
    docker rm   dxmonad-test
    echo "Bring up dxmonad-test"
    dxmonad_up  dxmonad-test "xmonad --recompile"
    echo "done recompiling"
else
    docker kill dxmonad
    docker rm   dxmonad
    echo "Starting dxmonad..."
    dxmonad_up  dxmonad
fi
